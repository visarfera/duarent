<!DOCTYPE html>
<html lang="sq">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DUA Rent | Sistemi Qendror</title>
  <link rel="icon" type="image/jpeg" href="https://i.imgur.com/SZIoCrF.jpeg">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .glass {
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
  </style>
</head>

<body class="bg-slate-950 text-slate-200 min-h-screen flex">

  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/95 glass">
    <div class="bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl max-w-md w-full p-8 fade-in">
      <!-- DUA RENT Logo -->
      <div class="mb-6 flex justify-center">
        <img src="https://i.imgur.com/SZIoCrF.jpeg" alt="DUA Rent"
          class="h-24 w-auto object-contain rounded-lg shadow-xl">
      </div>

      <h2 class="text-3xl font-bold text-white text-center mb-2">Mirësevini</h2>
      <p class="text-slate-400 text-center mb-8">Sistemi i menaxhimit të flotës</p>

      <div class="space-y-3">
        <button onclick="window.loginAsGuest()"
          class="w-full py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-medium transition-all flex items-center justify-center gap-2">
          <i data-lucide="user" class="w-5 h-5"></i>
          Vazhdo si Vizitor (Guest)
        </button>

        <div class="relative">
          <div class="absolute inset-0 flex items-center"><span class="w-full border-t border-slate-700"></span></div>
          <div class="relative flex justify-center text-xs"><span class="bg-slate-900 px-2 text-slate-500">OSE
              ADMINISTRATOR</span></div>
        </div>

        <div id="adminInputs" class="hidden space-y-3">
          <input type="email" id="adminEmail" placeholder="Email"
            class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white placeholder-slate-500 focus:ring-2 focus:ring-indigo-500 outline-none">
          <input type="password" id="adminPassword" placeholder="Fjalëkalimi"
            class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white placeholder-slate-500 focus:ring-2 focus:ring-indigo-500 outline-none"
            onkeypress="if(event.key==='Enter') window.loginAsAdmin()">
          <button onclick="window.loginAsAdmin()"
            class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold transition-all shadow-lg">Hyni</button>
          <p id="loginError" class="text-red-400 text-sm text-center hidden"></p>
        </div>

        <button id="showAdminBtn"
          onclick="document.getElementById('showAdminBtn').classList.add('hidden'); document.getElementById('adminInputs').classList.remove('hidden');"
          class="w-full py-3 border border-slate-700 hover:border-indigo-500 text-slate-300 hover:text-white rounded-xl font-medium transition-all flex items-center justify-center gap-2">
          <i data-lucide="shield-check" class="w-5 h-5"></i>
          Paneli i Administratorit
        </button>
      </div>

      <!-- VEROS Branding -->
      <div class="mt-8 pt-6 border-t border-slate-800 flex items-center justify-center gap-2 opacity-50">
        <span class="text-xs text-slate-500">Powered by</span>
        <img src="https://i.imgur.com/oksiI1G.png" alt="VEROS" class="h-5">
        <span class="text-xs font-semibold text-slate-400">VEROS</span>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <aside id="sidebar" class="hidden w-64 bg-slate-900 border-r border-slate-800 flex-col">
    <div class="p-6 flex items-center gap-3 border-b border-slate-800">
      <img src="https://i.imgur.com/SZIoCrF.jpeg" alt="Logo" class="w-10 h-10 rounded-lg shadow">
      <div>
        <h1 class="text-xl font-bold text-white">DUA<span class="font-light text-slate-400">Rent</span></h1>
        <span class="text-xs text-slate-500 uppercase" id="userRoleBadge">Guest</span>
      </div>
    </div>

    <nav class="flex-1 p-4 space-y-2 mt-2">
      <button onclick="window.renderDashboard()" id="nav-dashboard"
        class="admin-only hidden w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition-all">
        <i data-lucide="layout-grid" class="w-5 h-5"></i>
        <span class="font-medium">Paneli</span>
      </button>
      <button onclick="window.renderCars()" id="nav-cars"
        class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition-all">
        <i data-lucide="car" class="w-5 h-5"></i>
        <span class="font-medium">Veturat</span>
      </button>
      <button onclick="window.renderBookings()" id="nav-bookings"
        class="admin-only hidden w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition-all">
        <i data-lucide="calendar-days" class="w-5 h-5"></i>
        <span class="font-medium">Rezervimet</span>
      </button>
      <button onclick="window.renderClients()" id="nav-clients"
        class="admin-only hidden w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition-all">
        <i data-lucide="users" class="w-5 h-5"></i>
        <span class="font-medium">Klientët</span>
      </button>
    </nav>

    <div class="p-4 border-t border-slate-800 space-y-3">
      <button onclick="window.handleLogout()"
        class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-red-400 hover:bg-red-500/10 transition-all">
        <i data-lucide="log-out" class="w-5 h-5"></i>
        <span class="font-medium">Dilni</span>
      </button>

      <!-- VEROS Footer -->
      <div class="flex items-center justify-center gap-2 pt-3 border-t border-slate-800 opacity-40">
        <img src="https://i.imgur.com/oksiI1G.png" alt="VEROS" class="h-4">
        <span class="text-xs text-slate-500">© 2026 Developed by <span class="font-semibold">VEROS</span></span>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main id="mainContent" class="hidden flex-1 flex flex-col overflow-hidden">
    <header class="bg-slate-900/50 glass border-b border-slate-800 px-8 py-4 flex justify-between items-center">
      <div>
        <h2 id="pageTitle" class="text-2xl font-bold text-white">Dashboard</h2>
        <p id="pageSubtitle" class="text-slate-400 text-sm">Statistikat e përgjithshme</p>
      </div>
      <div class="flex items-center gap-2">
        <i data-lucide="calendar" class="w-4 h-4 text-indigo-400"></i>
        <span id="currentDate" class="text-sm text-slate-300 font-medium"></span>
      </div>
    </header>

    <div id="contentArea" class="flex-1 overflow-y-auto p-8"></div>
  </main>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-5 right-5 transform translate-y-20 opacity-0 transition-all duration-300 z-50">
    <div
      class="bg-slate-800 border-l-4 border-indigo-500 text-white px-6 py-4 rounded-lg shadow-2xl flex items-center gap-3 min-w-[300px]">
      <i data-lucide="check-circle" class="w-5 h-5 text-indigo-400"></i>
      <div>
        <h4 class="font-bold text-sm">Njoftim</h4>
        <p id="toastMessage" class="text-slate-300 text-sm"></p>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA2vUcgceBYtp3aXl-ie9QK_BOdFWN9wyo",
      authDomain: "dua-rent.firebaseapp.com",
      projectId: "dua-rent",
      storageBucket: "dua-rent.firebasestorage.app",
      messagingSenderId: "912156362545",
      appId: "1:912156362545:web:eed97b903255281f599210"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let cars = [];
    let bookings = [];
    let userRole = null;
    let currentPage = 'cars';

    // Firestore Listeners
    onSnapshot(collection(db, 'cars'), (snapshot) => {
      cars = snapshot.docs.map(doc => ({ ...doc.data(), firestoreId: doc.id }));
      renderCurrentPage();
    });

    onSnapshot(collection(db, 'bookings'), (snapshot) => {
      bookings = snapshot.docs.map(doc => ({ ...doc.data(), firestoreId: doc.id }));
      renderCurrentPage();
    });

    // Auth State
    onAuthStateChanged(auth, (user) => {
      if (user && !userRole) {
        userRole = 'admin';
        closeLoginModal();
        updateUIForRole();
        renderDashboard();
      }
    });

    // Helper Functions
    window.showToast = (msg) => {
      const toast = document.getElementById('toast');
      document.getElementById('toastMessage').textContent = msg;
      toast.classList.remove('translate-y-20', 'opacity-0');
      setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
    };

    function closeLoginModal() {
      document.getElementById('loginModal').classList.add('hidden');
      document.getElementById('sidebar').classList.remove('hidden');
      document.getElementById('sidebar').classList.add('flex');
      document.getElementById('mainContent').classList.remove('hidden');
    }

    function updateUIForRole() {
      document.getElementById('userRoleBadge').textContent = userRole === 'admin' ? 'Administrator' : 'Guest Mode';
      document.querySelectorAll('.admin-only').forEach(el => {
        el.classList.toggle('hidden', userRole !== 'admin');
      });
    }

    function renderCurrentPage() {
      if (currentPage === 'dashboard') renderDashboard();
      else if (currentPage === 'cars') renderCars();
      else if (currentPage === 'bookings') renderBookings();
      else if (currentPage === 'clients') renderClients();
    }

    // Authentication
    window.loginAsGuest = () => {
      userRole = 'guest';
      closeLoginModal();
      updateUIForRole();
      renderCars();
      showToast('Mirësevini si Vizitor!');
    };

    window.loginAsAdmin = async () => {
      const email = document.getElementById('adminEmail').value;
      const password = document.getElementById('adminPassword').value;
      const errorEl = document.getElementById('loginError');

      if (!email || !password) {
        errorEl.textContent = 'Plotësoni të gjitha fushat!';
        errorEl.classList.remove('hidden');
        return;
      }

      try {
        await signInWithEmailAndPassword(auth, email, password);
        userRole = 'admin';
        closeLoginModal();
        updateUIForRole();
        renderDashboard();
        showToast('Mirësevini, Administrator!');
      } catch (error) {
        errorEl.textContent = 'Email ose fjalëkalim gabim!';
        errorEl.classList.remove('hidden');
      }
    };

    window.handleLogout = async () => {
      if (userRole === 'admin') {
        await signOut(auth);
      }
      location.reload();
    };

    // Render Functions
    window.renderDashboard = () => {
      if (userRole !== 'admin') return;
      currentPage = 'dashboard';
      setActiveNav('nav-dashboard');
      document.getElementById('pageTitle').textContent = 'Dashboard';
      document.getElementById('pageSubtitle').textContent = 'Statistikat e përgjithshme';

      const total = cars.length;
      const available = cars.filter(c => c.status === 'E Lirë').length;
      const rented = cars.filter(c => c.status === 'Me Qira').length;
      const revenue = bookings.filter(b => b.status === 'approved').reduce((sum, b) => {
        const days = Math.ceil((new Date(b.endDate) - new Date(b.startDate)) / (1000 * 60 * 60 * 24)) + 1;
        return sum + (b.price * days);
      }, 0);

      document.getElementById('contentArea').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-slate-900 border border-slate-800 p-6 rounded-xl hover:border-indigo-500/30 transition-all">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-slate-400 text-sm">Totali</p>
                                <h3 class="text-3xl font-bold text-white mt-1">${total}</h3>
                            </div>
                            <div class="bg-blue-500/10 p-3 rounded-lg">
                                <i data-lucide="car" class="w-6 h-6 text-blue-400"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-900 border border-slate-800 p-6 rounded-xl hover:border-emerald-500/30 transition-all">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-slate-400 text-sm">Të Lira</p>
                                <h3 class="text-3xl font-bold text-white mt-1">${available}</h3>
                            </div>
                            <div class="bg-emerald-500/10 p-3 rounded-lg">
                                <i data-lucide="check-circle" class="w-6 h-6 text-emerald-400"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-900 border border-slate-800 p-6 rounded-xl hover:border-violet-500/30 transition-all">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-slate-400 text-sm">Me Qira</p>
                                <h3 class="text-3xl font-bold text-white mt-1">${rented}</h3>
                            </div>
                            <div class="bg-violet-500/10 p-3 rounded-lg">
                                <i data-lucide="calendar-days" class="w-6 h-6 text-violet-400"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-900 border border-slate-800 p-6 rounded-xl hover:border-emerald-500/30 transition-all">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-slate-400 text-sm">Të Hyrat</p>
                                <h3 class="text-2xl font-bold text-emerald-400 mt-1">€${revenue.toFixed(2)}</h3>
                            </div>
                            <div class="bg-emerald-500/10 p-3 rounded-lg">
                                <i data-lucide="wallet" class="w-6 h-6 text-emerald-400"></i>
                            </div>
                        </div>
                    </div>
                </div>
            `;
      lucide.createIcons();
    };

    window.renderCars = () => {
      currentPage = 'cars';
      setActiveNav('nav-cars');
      document.getElementById('pageTitle').textContent = 'Veturat';
      document.getElementById('pageSubtitle').textContent = `Totali: ${cars.length} vetura`;

      const statusColors = {
        'E Lirë': 'bg-emerald-500',
        'Me Qira': 'bg-violet-500',
        'Në Servis': 'bg-amber-500'
      };

      document.getElementById('contentArea').innerHTML = cars.length === 0 ?
        `<div class="text-center py-20">
                    <i data-lucide="car" class="w-16 h-16 text-slate-600 mx-auto mb-4"></i>
                    <p class="text-slate-400">Nuk ka vetura</p>
                </div>` :
        `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    ${cars.map(car => `
                        <div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden hover:border-indigo-500/30 transition-all">
                            <div class="h-48 bg-slate-800 relative">
                                <img src="${car.image}" alt="${car.name}" class="w-full h-full object-cover">
                                <span class="absolute top-3 left-3 px-3 py-1 ${statusColors[car.status]} text-white text-xs font-bold rounded-full">${car.status}</span>
                                <span class="absolute top-3 right-3 px-3 py-1 bg-slate-900/90 text-white text-xs font-bold rounded-full">€${car.price}/ditë</span>
                            </div>
                            <div class="p-4">
                                <h3 class="font-bold text-white text-lg">${car.name}</h3>
                                <p class="text-slate-400 text-sm font-mono">${car.plate}</p>
                                <div class="flex gap-4 mt-3 text-xs text-slate-400">
                                    <span class="flex items-center gap-1">
                                        <i data-lucide="fuel" class="w-3 h-3"></i> ${car.fuel}%
                                    </span>
                                    <span class="flex items-center gap-1">
                                        <i data-lucide="gauge" class="w-3 h-3"></i> ${parseInt(car.mileage).toLocaleString()} km
                                    </span>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>`;
      lucide.createIcons();
    };

    window.renderBookings = () => {
      if (userRole !== 'admin') return;
      currentPage = 'bookings';
      setActiveNav('nav-bookings');
      document.getElementById('pageTitle').textContent = 'Rezervimet';
      document.getElementById('pageSubtitle').textContent = `Totali: ${bookings.length} rezervime`;

      const statusBadges = {
        'pending': '<span class="px-2 py-1 bg-amber-500/10 text-amber-400 text-xs font-medium rounded">Në Pritje</span>',
        'approved': '<span class="px-2 py-1 bg-emerald-500/10 text-emerald-400 text-xs font-medium rounded">E Aprovuar</span>',
        'rejected': '<span class="px-2 py-1 bg-rose-500/10 text-rose-400 text-xs font-medium rounded">E Refuzuar</span>'
      };

      document.getElementById('contentArea').innerHTML = bookings.length === 0 ?
        `<div class="text-center py-20">
                    <i data-lucide="calendar-x" class="w-16 h-16 text-slate-600 mx-auto mb-4"></i>
                    <p class="text-slate-400">Nuk ka rezervime</p>
                </div>` :
        `<div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-slate-800 text-xs font-semibold text-slate-400 uppercase">
                            <tr>
                                <th class="px-6 py-4 text-left">ID</th>
                                <th class="px-6 py-4 text-left">Klienti</th>
                                <th class="px-6 py-4 text-left">Vetura</th>
                                <th class="px-6 py-4 text-left">Data</th>
                                <th class="px-6 py-4 text-left">Statusi</th>
                                <th class="px-6 py-4 text-right">Veprime</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-800">
                            ${bookings.map(b => `
                                <tr class="hover:bg-slate-800/50">
                                    <td class="px-6 py-4 text-sm text-white font-mono">${b.id}</td>
                                    <td class="px-6 py-4 text-sm text-slate-300">${b.client}</td>
                                    <td class="px-6 py-4 text-sm text-slate-400">${b.car}</td>
                                    <td class="px-6 py-4 text-sm text-slate-400">${b.startDate} - ${b.endDate}</td>
                                    <td class="px-6 py-4">${statusBadges[b.status]}</td>
                                    <td class="px-6 py-4 text-right">
                                        <div class="flex justify-end gap-2">
                                            ${b.status === 'pending' ? `
                                                <button onclick="window.approveBooking('${b.firestoreId}')" class="p-2 bg-emerald-500/10 text-emerald-400 rounded hover:bg-emerald-500/20">
                                                    <i data-lucide="check" class="w-4 h-4"></i>
                                                </button>
                                                <button onclick="window.rejectBooking('${b.firestoreId}')" class="p-2 bg-rose-500/10 text-rose-400 rounded hover:bg-rose-500/20">
                                                    <i data-lucide="x" class="w-4 h-4"></i>
                                                </button>
                                            ` : ''}
                                            <button onclick="window.deleteBooking('${b.firestoreId}')" class="p-2 bg-slate-700 text-slate-400 rounded hover:bg-rose-500/20 hover:text-rose-400">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>`;
      lucide.createIcons();
    };

    window.renderClients = () => {
      if (userRole !== 'admin') return;
      currentPage = 'clients';
      setActiveNav('nav-clients');
      document.getElementById('pageTitle').textContent = 'Klientët';
      document.getElementById('pageSubtitle').textContent = 'Lista e auto-gjeneruar';

      const clientsMap = new Map();
      bookings.forEach(b => {
        const key = b.clientId || b.client;
        if (clientsMap.has(key)) {
          clientsMap.get(key).count++;
        } else {
          clientsMap.set(key, { name: b.client, id: b.clientId, count: 1 });
        }
      });

      const clients = Array.from(clientsMap.values());

      document.getElementById('contentArea').innerHTML = clients.length === 0 ?
        `<div class="text-center py-20">
                    <i data-lucide="users" class="w-16 h-16 text-slate-600 mx-auto mb-4"></i>
                    <p class="text-slate-400">Nuk ka klientë</p>
                </div>` :
        `<div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-slate-800 text-xs font-semibold text-slate-400 uppercase">
                            <tr>
                                <th class="px-6 py-4 text-left">Emri</th>
                                <th class="px-6 py-4 text-left">Nr. ID</th>
                                <th class="px-6 py-4 text-center">Rezervime</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-800">
                            ${clients.map(c => `
                                <tr class="hover:bg-slate-800/50">
                                    <td class="px-6 py-4">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 rounded-full bg-violet-500/20 flex items-center justify-center text-violet-400 font-bold">
                                                ${c.name.charAt(0).toUpperCase()}
                                            </div>
                                            <span class="text-white font-medium">${c.name}</span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 text-slate-400 font-mono">${c.id || 'N/A'}</td>
                                    <td class="px-6 py-4 text-center">
                                        <span class="inline-block px-3 py-1 bg-slate-800 text-white text-sm font-bold rounded-full">${c.count}</span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>`;
      lucide.createIcons();
    };

    // CRUD Operations
    window.approveBooking = async (id) => {
      await updateDoc(doc(db, 'bookings', id), { status: 'approved' });
      showToast('Rezervimi u aprovua!');
    };

    window.rejectBooking = async (id) => {
      await updateDoc(doc(db, 'bookings', id), { status: 'rejected' });
      showToast('Rezervimi u refuzua!');
    };

    window.deleteBooking = async (id) => {
      await deleteDoc(doc(db, 'bookings', id));
      showToast('Rezervimi u fshi!');
    };

    function setActiveNav(id) {
      document.querySelectorAll('nav button').forEach(btn => {
        btn.classList.remove('bg-indigo-600/10', 'text-indigo-400');
        btn.classList.add('text-slate-400');
      });
      const activeBtn = document.getElementById(id);
      if (activeBtn) {
        activeBtn.classList.add('bg-indigo-600/10', 'text-indigo-400');
        activeBtn.classList.remove('text-slate-400');
      }
    }

    // Initialize
    document.getElementById('currentDate').textContent = new Date().toLocaleDateString('sq-AL', { weekday: 'short', month: 'short', day: 'numeric' });
    lucide.createIcons();
  </script>
</body>

</html>
